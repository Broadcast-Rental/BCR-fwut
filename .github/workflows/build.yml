name: Build Executables

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0, v1.2.3, etc.
  pull_request:
    branches: [ main ]
  release:
    types: [ created ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Extract version from tag
      id: get_version
      shell: bash
      run: |
        if [[ "${{ github.event_name }}" == "release" ]]; then
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix if present
        elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION="${GITHUB_REF#refs/tags/}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix if present
        else
          VERSION="dev-$(git rev-parse --short HEAD)"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r build-tools/requirements.txt
        pip install pyinstaller
    
    - name: Install avrdude
      run: |
        # Install Arduino CLI which includes complete avrdude with all DLLs
        choco install arduino-cli -y
        arduino-cli core install arduino:avr
        
        # Find Arduino installation
        $arduinoPath = "$env:LOCALAPPDATA\Arduino15\packages\arduino\tools\avrdude"
        $avrdudeVersion = Get-ChildItem $arduinoPath | Select-Object -First 1 -ExpandProperty Name
        $avrdudeBin = "$arduinoPath\$avrdudeVersion\bin"
        $avrdudeEtc = "$arduinoPath\$avrdudeVersion\etc"
        
        Write-Host "Using avrdude from: $avrdudeBin"
        
        # Create tools directory
        mkdir tools -ErrorAction SilentlyContinue
        
        # Copy avrdude and ALL its dependencies
        Copy-Item "$avrdudeBin\avrdude.exe" -Destination "tools\" -Force
        Copy-Item "$avrdudeEtc\avrdude.conf" -Destination "tools\" -Force
        Get-ChildItem "$avrdudeBin\*.dll" | Copy-Item -Destination "tools\" -Force
        
        # List what we bundled
        Write-Host "`nBundled avrdude files:"
        Get-ChildItem "tools\" | Format-Table Name, Length
      shell: powershell
    
    - name: Set version in environment
      run: |
        echo "FW_VERSION=${{ steps.get_version.outputs.version }}" >> $GITHUB_ENV
        echo "Building with version: ${{ steps.get_version.outputs.version }}"
      shell: bash
    
    - name: Create version file
      run: echo ${{ steps.get_version.outputs.version }} > src/_version.txt
      shell: bash
    
    - name: Build executable
      run: |
        echo "Version being built: %FW_VERSION%"
        pyinstaller --clean build-tools\firmware_uploader.spec
      env:
        FW_VERSION: ${{ steps.get_version.outputs.version }}
    
    - name: Verify version in executable
      run: |
        strings dist/FirmwareUploader.exe | grep -i "v${{ steps.get_version.outputs.version }}" || echo "Warning: Version string not found in executable"
      shell: bash
      continue-on-error: true
    
    - name: Rename executable with version
      shell: bash
      run: |
        mv dist/FirmwareUploader.exe "dist/FirmwareUploader-v${{ steps.get_version.outputs.version }}.exe"
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: FirmwareUploader-Windows-v${{ steps.get_version.outputs.version }}
        path: dist/FirmwareUploader-v${{ steps.get_version.outputs.version }}.exe
        retention-days: 30
    
    - name: Create Release and Upload Assets
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/FirmwareUploader-v${{ steps.get_version.outputs.version }}.exe
        draft: false
        prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
        generate_release_notes: true
        name: "Firmware Uploader v${{ steps.get_version.outputs.version }}"
        body: |
          ## Firmware Uploader v${{ steps.get_version.outputs.version }}
          
          ### Downloads
          - **Windows:** `FirmwareUploader-v${{ steps.get_version.outputs.version }}.exe`
          - **macOS:** `FirmwareUploader-v${{ steps.get_version.outputs.version }}.dmg`
          
          ### Installation
          **Windows:** Download the `.exe` file and run it
          **macOS:** Download the `.dmg`, open it, and drag the app to Applications. Right-click and select "Open" the first time.
          
          ---
          
          Developed by Daniël Vegter - Broadcast Rental
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Extract version from tag
      id: get_version
      run: |
        if [[ "${{ github.event_name }}" == "release" ]]; then
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix if present
        elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION="${GITHUB_REF#refs/tags/}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix if present
        else
          VERSION="dev-$(git rev-parse --short HEAD)"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r build-tools/requirements.txt
        pip install pyinstaller
    
    - name: Install avrdude
      run: |
        brew install avrdude
        mkdir -p tools
        cp $(which avrdude) tools/
        cp $(brew --prefix)/etc/avrdude.conf tools/ || cp /usr/local/etc/avrdude.conf tools/ || true
    
    - name: Set version in environment
      run: |
        echo "FW_VERSION=${{ steps.get_version.outputs.version }}" >> $GITHUB_ENV
        echo "Building with version: ${{ steps.get_version.outputs.version }}"
    
    - name: Create version file
      run: echo ${{ steps.get_version.outputs.version }} > src/_version.txt
    
    - name: Build executable
      run: |
        echo "Version being built: $FW_VERSION"
        pyinstaller --clean build-tools/firmware_uploader.spec
      env:
        FW_VERSION: ${{ steps.get_version.outputs.version }}
    
    - name: Verify version in executable
      run: |
        strings dist/FirmwareUploader.app/Contents/MacOS/FirmwareUploader | grep -i "v${{ steps.get_version.outputs.version }}" || echo "Warning: Version string not found in executable"
      continue-on-error: true
    
    - name: Fix macOS permissions and quarantine
      run: |
        # Make the app executable
        chmod -R +x dist/FirmwareUploader.app/Contents/MacOS/
        # Remove quarantine attribute (helps with "app is damaged" error)
        xattr -cr dist/FirmwareUploader.app || true
        # Ad-hoc code sign with entitlements (allows serial port access)
        codesign --force --deep --sign - --entitlements build-tools/entitlements.plist dist/FirmwareUploader.app || true
        # Verify the signature
        codesign --verify --verbose dist/FirmwareUploader.app || true
    
    - name: Create DMG (optional)
      run: |
        brew install create-dmg || true
        if command -v create-dmg &> /dev/null; then
          create-dmg \
            --volname "Firmware Uploader v${{ steps.get_version.outputs.version }}" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --app-drop-link 425 120 \
            "dist/FirmwareUploader-v${{ steps.get_version.outputs.version }}.dmg" \
            "dist/FirmwareUploader.app" || \
          hdiutil create -volname "Firmware Uploader v${{ steps.get_version.outputs.version }}" -srcfolder dist/FirmwareUploader.app -ov -format UDZO "dist/FirmwareUploader-v${{ steps.get_version.outputs.version }}.dmg"
        else
          hdiutil create -volname "Firmware Uploader v${{ steps.get_version.outputs.version }}" -srcfolder dist/FirmwareUploader.app -ov -format UDZO "dist/FirmwareUploader-v${{ steps.get_version.outputs.version }}.dmg"
        fi
    
    - name: Upload macOS app artifact
      uses: actions/upload-artifact@v4
      with:
        name: FirmwareUploader-macOS-app-v${{ steps.get_version.outputs.version }}
        path: dist/FirmwareUploader.app
        retention-days: 30
    
    - name: Upload macOS DMG artifact
      uses: actions/upload-artifact@v4
      with:
        name: FirmwareUploader-macOS-dmg-v${{ steps.get_version.outputs.version }}
        path: dist/FirmwareUploader-v${{ steps.get_version.outputs.version }}.dmg
        retention-days: 30
    
    - name: Create Release and Upload Assets
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/FirmwareUploader-v${{ steps.get_version.outputs.version }}.dmg
        draft: false
        prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
        generate_release_notes: true
        name: "Firmware Uploader v${{ steps.get_version.outputs.version }}"
        body: |
          ## Firmware Uploader v${{ steps.get_version.outputs.version }}
          
          ### Downloads
          - **Windows:** `FirmwareUploader-v${{ steps.get_version.outputs.version }}.exe`
          - **macOS:** `FirmwareUploader-v${{ steps.get_version.outputs.version }}.dmg`
          
          ### Installation
          **Windows:** Download the `.exe` file and run it
          **macOS:** Download the `.dmg`, open it, and drag the app to Applications. Right-click and select "Open" the first time.
          
          ---
          
          Developed by Daniël Vegter - Broadcast Rental
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

