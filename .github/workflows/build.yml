name: Build Executables

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ created ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r build-tools/requirements.txt
        pip install pyinstaller
    
    - name: Install avrdude
      run: |
        choco install avrdude -y
        mkdir tools
        Copy-Item "C:\ProgramData\chocolatey\lib\avrdude\tools\avrdude.exe" -Destination "tools\"
        Copy-Item "C:\ProgramData\chocolatey\lib\avrdude\tools\avrdude.conf" -Destination "tools\"
        Copy-Item "C:\ProgramData\chocolatey\lib\avrdude\tools\*.dll" -Destination "tools\" -ErrorAction SilentlyContinue
      shell: powershell
    
    - name: Build executable
      run: pyinstaller --clean build-tools\firmware_uploader.spec
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: FirmwareUploader-Windows
        path: dist/FirmwareUploader.exe
        retention-days: 30
    
    - name: Upload to release (if release)
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: dist/FirmwareUploader.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r build-tools/requirements.txt
        pip install pyinstaller
    
    - name: Install avrdude
      run: |
        brew install avrdude
        mkdir -p tools
        cp $(which avrdude) tools/
        cp $(brew --prefix)/etc/avrdude.conf tools/ || cp /usr/local/etc/avrdude.conf tools/ || true
    
    - name: Build executable
      run: pyinstaller --clean build-tools/firmware_uploader.spec
    
    - name: Create DMG (optional)
      run: |
        brew install create-dmg || true
        if command -v create-dmg &> /dev/null; then
          create-dmg \
            --volname "Firmware Uploader" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --app-drop-link 425 120 \
            "dist/FirmwareUploader.dmg" \
            "dist/FirmwareUploader.app" || \
          hdiutil create -volname "Firmware Uploader" -srcfolder dist/FirmwareUploader.app -ov -format UDZO dist/FirmwareUploader.dmg
        else
          hdiutil create -volname "Firmware Uploader" -srcfolder dist/FirmwareUploader.app -ov -format UDZO dist/FirmwareUploader.dmg
        fi
    
    - name: Upload macOS app artifact
      uses: actions/upload-artifact@v4
      with:
        name: FirmwareUploader-macOS-app
        path: dist/FirmwareUploader.app
        retention-days: 30
    
    - name: Upload macOS DMG artifact
      uses: actions/upload-artifact@v4
      with:
        name: FirmwareUploader-macOS-dmg
        path: dist/FirmwareUploader.dmg
        retention-days: 30
    
    - name: Upload to release (if release)
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/FirmwareUploader.dmg
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

